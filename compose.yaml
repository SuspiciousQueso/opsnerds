services:
  opsnerds-caddy:
    image: caddy:2
    container_name: opsnerds-caddy
    depends_on:
      - opsnerds-php
    ports:
      # Pick a unique host port; NPM proxies to this (example 8088)
      - "8088:80"
    volumes:
      - .:/var/www/html:delegated
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    networks:
      - opsnerds_internal
      - infrastructure_management_net
    restart: unless-stopped

  opsnerds-php:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: opsnerds-php
    volumes:
      - .:/var/www/html:delegated
    depends_on:
      opsnerds-db:
        condition: service_healthy
    networks:
      - opsnerds_internal
    restart: unless-stopped

  opsnerds-db:
    image: mariadb:11
    container_name: opsnerds-db
    environment:
      MARIADB_DATABASE: ${DB_NAME:-opsnerds}
      MARIADB_USER: ${DB_USER:-opsnerds}
      MARIADB_PASSWORD: ${DB_PASSWORD:-opsnerds_password}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_password_here}
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - db_data:/var/lib/mysql
      - ./migrations/master_init.sql:/docker-entrypoint-initdb.d/1-setup.sql:ro
    networks:
      - opsnerds_internal
    restart: unless-stopped

volumes:
  db_data:

networks:
  opsnerds_internal:
    driver: bridge

  infrastructure_management_net:
    external: true
